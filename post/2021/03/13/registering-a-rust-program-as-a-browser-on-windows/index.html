<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Registering a (Rust) program as a browser on Windows - Jørgen's Blog</title>
  <meta name="author" content="Jørgen Tjernø">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://jorgen.tjer.no/post/2021/03/13/registering-a-rust-program-as-a-browser-on-windows/">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Jørgen's Blog" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://jorgen.tjer.no/post/2021/03/13/registering-a-rust-program-as-a-browser-on-windows/">
  <meta property="og:title" content="Registering a (Rust) program as a browser on Windows - Jørgen's Blog">
  

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">

<link href="/assets/fontawesome/css/fontawesome.min.css" rel="stylesheet" type="text/css">
<link href="/assets/fontawesome/css/solid.min.css" rel="stylesheet" type="text/css">
<link href="/assets/fontawesome/css/brands.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-51279149-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jørgen's Blog</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li>
                    <a rel="me" href="https://mastodon.gamedev.place/@jorgenpt"><i class="fa-brands fa-mastodon fa-lg"></i></a>
                </li>
                <li>
                    <a rel="me" href="https://github.com/jorgenpt"><i class="fa-brands fa-github fa-lg"></i></a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="jorgen.tjer.no">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Jørgen's Blog" />
    
    <meta itemprop="url" content="https://jorgen.tjer.no" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2021-03-13T17:43:00-08:00"  data-updated="true" itemprop="datePublished dateCreated">13 Mar, 2021</time>
        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        Registering a (Rust) program as a browser on Windows
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody description"><p>Registering as a potential web browser in modern Windows versions is mostly just about configuring a handful of registry keys, and there&rsquo;s nothing particularly tricky about doing so in Rust. Exactly what you need to configure (and why) can be hard to divine, and so I&rsquo;ll walk through the various registry keys that are expected, why, and show sample Rust code for setting them. In addition, there&rsquo;s a small call to <code>SHChangeNotify</code> that&rsquo;s required to refresh the OS' notion of available browsers, and that requires a snippet of unsafe Rust code.</p>

<p>I figured out all this while writing an app that pretends to be a browser and forwards URLs to the appropriate browser based on pattern matching. I named it <a href="https://github.com/jorgenpt/bichrome">bichrome</a>, and you can find a <a href="https://github.com/jorgenpt/bichrome/blob/04e8a4476105501032121c05f487f592c6ca68ce/src/windows.rs#L53">full example of URL registration in bichrome&rsquo;s src/windows.rs</a>, or keep reading to learn why these parts are needed and how to adapt it to your program!</p>

<!-- more -->


<p>You&rsquo;ll need to pick a couple of arbitrary identifiers. There&rsquo;s a &ldquo;canonical name&rdquo; for your browser (for <a href="https://github.com/jorgenpt/bichrome">bichrome</a> I chose <code>bichrome.exe</code>) and a program ID for your URL associations (for <a href="https://github.com/jorgenpt/bichrome">bichrome</a> I chose <code>bichromeHTML</code>), and these will be referred to as <code>CANONICAL_NAME</code> and <code>PROGID</code> in the samples. You&rsquo;ll also need <code>DISPLAY_NAME</code> and <code>DESCRIPTION</code>, which are simply user-facing names &amp; descriptions for your application.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kr">const</span> <span class="n">CANONICAL_NAME</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span> <span class="o">=</span> <span class="s">&quot;bichrome.exe&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="n">PROGID</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span> <span class="o">=</span> <span class="s">&quot;bichromeHTML&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="n">DISPLAY_NAME</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span> <span class="o">=</span> <span class="s">&quot;bichrome&quot;</span><span class="p">;</span>
</span><span class='line'><span class="kr">const</span> <span class="n">DESCRIPTION</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span> <span class="o">=</span> <span class="s">&quot;Pick the right Chrome profile for each URL&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The samples will use the <a href="https://crates.io/crates/const_format">const_format</a> crate for its <a href="https://docs.rs/const_format/0.2.13/const_format/macro.concatcp.html"><code>concatcp!</code></a> macro, the <a href="https://crates.io/crates/winreg">winreg</a> crate to write to the registry, and <a href="https://crates.io/crates/windows">windows-rs</a> to call <code>SHChangeNotify</code>.</p>

<a name="ProgID.registration"></a>
<h2>ProgID registration</h2>

<p>Registering the ProgID we&rsquo;ve picked lets us use the ProgID in file &amp; URL associations, so that Windows knows what commands to invoke when a particular file or URL gets handled by our ProgID.  The registration happens by configuring <code>SOFTWARE\CLASSES\&lt;PROGID&gt;</code> and it&rsquo;s subkeys <code>DefaultIcon</code> and <code>shell\open\command</code>. The latter is what gets invoked when our ProgID is asked to handle something.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">env</span><span class="o">::</span><span class="n">current_exe</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Find the current executable&#39;s name, which we&#39;ll use to register</span>
</span><span class='line'><span class="kd">let</span> <span class="n">exe_path</span> <span class="o">=</span> <span class="n">current_exe</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="kd">let</span> <span class="n">exe_name</span> <span class="o">=</span> <span class="n">exe_path</span>
</span><span class='line'>    <span class="p">.</span><span class="n">file_name</span><span class="p">()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="n">to_str</span><span class="p">())</span>
</span><span class='line'>    <span class="p">.</span><span class="n">flatten</span><span class="p">()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">unwrap_or_default</span><span class="p">()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">to_owned</span><span class="p">();</span>
</span><span class='line'><span class="kd">let</span> <span class="n">exe_path</span> <span class="o">=</span> <span class="n">exe_path</span><span class="p">.</span><span class="n">to_str</span><span class="p">().</span><span class="n">unwrap_or_default</span><span class="p">().</span><span class="n">to_owned</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// We&#39;re assuming that the registration will use the icon resource of our EXE</span>
</span><span class='line'><span class="kd">let</span> <span class="n">icon_path</span> <span class="o">=</span> <span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{}</span><span class="se">\&quot;</span><span class="s">,0&quot;</span><span class="p">,</span> <span class="n">exe_path</span><span class="p">);</span>
</span><span class='line'><span class="c1">// This is the command that will get invoked</span>
</span><span class='line'><span class="kd">let</span> <span class="n">open_command</span> <span class="o">=</span> <span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{}</span><span class="se">\&quot;</span><span class="s"> </span><span class="se">\&quot;</span><span class="s">%1</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">exe_path</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// We write to the local user&#39;s registry, so that it does not require administrative</span>
</span><span class='line'><span class="c1">// privileges to update.</span>
</span><span class='line'><span class="kd">let</span> <span class="n">hkcu</span> <span class="o">=</span> <span class="n">RegKey</span><span class="o">::</span><span class="n">predef</span><span class="p">(</span><span class="n">HKEY_CURRENT_USER</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kr">const</span> <span class="n">PROGID_CLASS_PATH</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span> <span class="o">=</span> <span class="n">concatcp</span><span class="o">!</span><span class="p">(</span><span class="s-Raw">r&quot;SOFTWARE\Classes\&quot;</span><span class="p">,</span> <span class="n">PROGID</span><span class="p">);</span>
</span><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">progid_class</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">hkcu</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="n">PROGID_CLASS_PATH</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">progid_class</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DISPLAY_NAME</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">progid_class_defaulticon</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">progid_class</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="s">&quot;DefaultIcon&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">progid_class_defaulticon</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icon_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">progid_class_shell_open_command</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">progid_class</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="s-Raw">r&quot;shell\open\command&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">progid_class_shell_open_command</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open_command</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Configuring.the.Default.Programs"></a>
<h2>Configuring the Default Programs</h2>

<p>Default Programs is the user flow that Windows 10 uses to let the user configure defaults for their browser, email client, et cetera. You can read about it in detail <a href="https://docs.microsoft.com/en-us/windows/win32/shell/default-programs">on the MSDN page</a>.</p>

<p>To become a valid browser, we need to register some information about our application, let the OS know we&rsquo;re a browser-type application, tell it which URLs and file types we&rsquo;re capable of handling, and let it know how to launch, register, and unregister us.</p>

<p>First, we set up the high level information &ndash; display name, our icon, and name &amp; description:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kr">const</span> <span class="n">DPROG_PATH</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span> <span class="o">=</span> <span class="n">concatcp</span><span class="o">!</span><span class="p">(</span><span class="s-Raw">r&quot;SOFTWARE\Clients\StartMenuInternet\&quot;</span><span class="p">,</span> <span class="n">CANONICAL_NAME</span><span class="p">);</span>
</span><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">dprog</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">hkcu</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="n">DPROG_PATH</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">dprog</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DISPLAY_NAME</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">dprog</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;LocalizedString&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DISPLAY_NAME</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">dprog_defaulticon</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">dprog</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="s">&quot;DefaultIcon&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">dprog_defaulticon</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icon_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">dprog_capabilites</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">dprog</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="s">&quot;Capabilities&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">dprog_capabilites</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;ApplicationName&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DISPLAY_NAME</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">dprog_capabilites</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;ApplicationIcon&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">icon_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">dprog_capabilites</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;ApplicationDescription&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DESCRIPTION</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we tell the OS we have a <a href="https://docs.microsoft.com/en-us/windows/win32/shell/default-programs#startmenu">StartMenuInternet capability</a>, and then link this browser&rsquo;s URL &amp; file associations to the program ID we chose (and registered above).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">dprog_capabilities_startmenu</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">dprog_capabilites</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="s">&quot;Startmenu&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">dprog_capabilities_startmenu</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;StartMenuInternet&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">CANONICAL_NAME</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Register for various URL protocols that our target browsers might support.</span>
</span><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">dprog_capabilities_urlassociations</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">dprog_capabilites</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="s">&quot;URLAssociations&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="n">protocol</span> <span class="k">in</span> <span class="o">&amp;</span><span class="p">[</span><span class="s">&quot;ftp&quot;</span><span class="p">,</span> <span class="s">&quot;http&quot;</span><span class="p">,</span> <span class="s">&quot;https&quot;</span><span class="p">,</span> <span class="s">&quot;webcal&quot;</span><span class="p">]</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">dprog_capabilities_urlassociations</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PROGID</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Register for various file types, so that we&#39;ll be invoked for file:// URLs for these types (e.g.</span>
</span><span class='line'><span class="c1">// by `cargo doc --open`.)</span>
</span><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">dprog_capabilities_fileassociations</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">dprog_capabilites</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="s">&quot;FileAssociations&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="n">filetype</span> <span class="k">in</span> <span class="o">&amp;</span><span class="p">[</span>
</span><span class='line'>    <span class="s">&quot;.htm&quot;</span><span class="p">,</span> <span class="s">&quot;.html&quot;</span><span class="p">,</span> <span class="s">&quot;.pdf&quot;</span><span class="p">,</span> <span class="s">&quot;.shtml&quot;</span><span class="p">,</span> <span class="s">&quot;.svg&quot;</span><span class="p">,</span> <span class="s">&quot;.webp&quot;</span><span class="p">,</span> <span class="s">&quot;.xht&quot;</span><span class="p">,</span> <span class="s">&quot;.xhtml&quot;</span><span class="p">,</span>
</span><span class='line'><span class="p">]</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">dprog_capabilities_fileassociations</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">filetype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">PROGID</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To finalize the Default Programs configuration, we set up the <a href="https://docs.microsoft.com/en-us/windows/win32/shell/reg-middleware-apps#registering-installation-information">installation information</a> which allows the OS to register &amp; unregister us. You can read about the expectations for e.g. the reinstall command <a href="https://docs.microsoft.com/en-us/windows/win32/shell/reg-middleware-apps#the-reinstall-command">on this MSDN page</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="c1">// Set up reinstallation and show/hide icon commands (https://docs.microsoft.com/en-us/windows/win32/shell/reg-middleware-apps#registering-installation-information)</span>
</span><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">dprog_installinfo</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">dprog</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="s">&quot;InstallInfo&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">dprog_installinfo</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;ReinstallCommand&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{}</span><span class="se">\&quot;</span><span class="s"> register&quot;</span><span class="p">,</span> <span class="n">exe_path</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">dprog_installinfo</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;HideIconsCommand&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{}</span><span class="se">\&quot;</span><span class="s"> hide-icons&quot;</span><span class="p">,</span> <span class="n">exe_path</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">dprog_installinfo</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;ShowIconsCommand&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">{}</span><span class="se">\&quot;</span><span class="s"> show-icons&quot;</span><span class="p">,</span> <span class="n">exe_path</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Only update IconsVisible if it hasn&#39;t been set already</span>
</span><span class='line'><span class="k">if</span> <span class="kd">let</span> <span class="nb">Err</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">dprog_installinfo</span><span class="p">.</span><span class="n">get_value</span><span class="o">::&lt;</span><span class="kt">u32</span><span class="p">,</span> <span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;IconsVisible&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">dprog_installinfo</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;IconsVisible&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="mi">1</span><span class="k">u32</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">dprog_shell_open_command</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">dprog</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="s-Raw">r&quot;shell\open\command&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="n">dprog_shell_open_command</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">open_command</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Tying.it.all.together"></a>
<h2>Tying it all together</h2>

<p>Finally, we just need to create a <a href="https://docs.microsoft.com/en-us/windows/win32/shell/default-programs#registeredapplications">Registered Application</a> that maps our application name to the Default Programs capabilities we listed, and set up an app path for convenience sake &ndash; so that <code>myprogram.exe</code> can resolve to our program without needing to modify the <code>PATH</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="c1">// Set up a registered application for our Default Programs capabilities (https://docs.microsoft.com/en-us/windows/win32/shell/default-programs#registeredapplications)</span>
</span><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">registered_applications</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">hkcu</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="s-Raw">r&quot;SOFTWARE\RegisteredApplications&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="kd">let</span> <span class="n">dprog_capabilities_path</span> <span class="o">=</span> <span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s-Raw">r&quot;{}\Capabilities&quot;</span><span class="p">,</span> <span class="n">DPROG_PATH</span><span class="p">);</span>
</span><span class='line'><span class="n">registered_applications</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">DISPLAY_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dprog_capabilities_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Application Registration (https://docs.microsoft.com/en-us/windows/win32/shell/app-registration)</span>
</span><span class='line'><span class="kd">let</span> <span class="n">appreg_path</span> <span class="o">=</span> <span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s-Raw">r&quot;SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\{}&quot;</span><span class="p">,</span> <span class="n">exe_name</span><span class="p">);</span>
</span><span class='line'><span class="kd">let</span> <span class="p">(</span><span class="n">appreg</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">hkcu</span><span class="p">.</span><span class="n">create_subkey</span><span class="p">(</span><span class="n">APPREG_PATH</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="c1">// This is used to resolve &quot;myprogram.exe&quot; -&gt; full path, if needed.</span>
</span><span class='line'><span class="n">appreg</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exe_path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span><span class='line'><span class="c1">// UseUrl indicates that we don&#39;t need the shell to download a file for us -- we can handle direct</span>
</span><span class='line'><span class="c1">// HTTP URLs.</span>
</span><span class='line'><span class="n">appreg</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">&quot;UseUrl&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="mi">1</span><span class="k">u32</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Letting.the.OS.know.we.re.good.to.go"></a>
<h2>Letting the OS know we&rsquo;re good to go</h2>

<p>As one last step, we <a href="https://docs.microsoft.com/en-us/windows/win32/shell/default-programs#becoming-the-default-browser">notify the OS that the available URL handlers have changed</a>, so that it will refresh the list of browsers, and if this is our first registration, automatically prompt the user if they&rsquo;d like to change their default.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kn">mod</span> <span class="n">windows_bindings</span> <span class="p">{</span>
</span><span class='line'>    <span class="o">::</span><span class="n">windows</span><span class="o">::</span><span class="n">include_bindings</span><span class="o">!</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kn">use</span> <span class="n">windows_bindings</span><span class="o">::</span><span class="n">windows</span><span class="o">::</span><span class="n">win32</span><span class="o">::</span><span class="n">shell</span><span class="o">::</span><span class="p">{</span><span class="n">SHChangeNotify</span><span class="p">,</span> <span class="n">SHCNE_ID</span><span class="p">,</span> <span class="n">SHCNF_FLAGS</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Notify the shell about the updated URL associations. (https://docs.microsoft.com/en-us/windows/win32/shell/default-programs#becoming-the-default-browser)</span>
</span><span class='line'><span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">SHChangeNotify</span><span class="p">(</span>
</span><span class='line'>        <span class="n">SHCNE_ID</span><span class="o">::</span><span class="n">SHCNE_ASSOCCHANGED</span><span class="p">,</span>
</span><span class='line'>        <span class="n">SHCNF_FLAGS</span><span class="o">::</span><span class="n">SHCNF_DWORD</span> <span class="o">|</span> <span class="n">SHCNF_FLAGS</span><span class="o">::</span><span class="n">SHCNF_FLUSH</span><span class="p">,</span>
</span><span class='line'>        <span class="n">std</span><span class="o">::</span><span class="n">ptr</span><span class="o">::</span><span class="n">null_mut</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">std</span><span class="o">::</span><span class="n">ptr</span><span class="o">::</span><span class="n">null_mut</span><span class="p">(),</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Setting up windows-rs is a little bit heavier weight than most crates &ndash; you can find documentation on <a href="https://crates.io/crates/windows">the crates.io page for the windows crate</a>, but a minimal example is shown below. First, add the following to your <code>Cargo.toml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='toml'><span class='line'><span class="p">[</span><span class="n">dependencies</span><span class="p">]</span>
</span><span class='line'><span class="n">windows</span> <span class="o">=</span> <span class="s">&quot;0.4.0&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">build-dependencies</span><span class="p">]</span>
</span><span class='line'><span class="n">windows</span> <span class="o">=</span> <span class="s">&quot;0.4.0&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you&rsquo;ll also need to specify a <code>build.rs</code> script that generates the appropriate bindings for you:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">windows</span><span class="o">::</span><span class="n">build</span><span class="o">!</span><span class="p">(</span><span class="n">windows</span><span class="o">::</span><span class="n">win32</span><span class="o">::</span><span class="n">shell</span><span class="o">::*</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<a name="Being.suave.about.it"></a>
<h2>Being suave about it</h2>

<p>By default Rust applications use the &ldquo;console&rdquo; subsystem on Windows &ndash; this means you can more or less always write to the console and have it show up somewhere. The downside of this is that if the application is run outside of a console window, e.g. by double-clicking the EXE or when invoked as a browser by the OS, you&rsquo;ll see a console window pop up. Luckily, since Rust 1.18, it&rsquo;s quite trivial to switch to the Windows subsystem. Just add the following to the top of your <code>main.rs</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="err">#</span><span class="o">!</span><span class="p">[</span><span class="n">windows_subsystem</span> <span class="o">=</span> <span class="s">&quot;windows&quot;</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<a name="In.closing"></a>
<h2>In closing</h2>

<p>If you&rsquo;re looking to just drop this in to your own project, I would suggest you look at <a href="https://github.com/jorgenpt/bichrome/blob/04e8a4476105501032121c05f487f592c6ca68ce/src/windows.rs#L53">the full example in bichrome&rsquo;s src/windows.rs</a>, which has all the various parts in two methods (<code>register_urlhandler</code> and <code>refresh_shell</code>).</p>

<p>Once you&rsquo;ve done all this, your application should show up like any other browser in the <code>Default apps</code> selection in Windows 10, like <a href="https://github.com/jorgenpt/bichrome">bichrome</a> in this screenshot:</p>

<p><img class="center" src="/images/default_apps.png"></p>

<p>Please let me know if you have any questions or just to say that this was helpful to you! You can leave a comment, hit me up on <a href="https://twitter.com/jorgenpt">twitter (@jorgenpt)</a>, or send me <a href="mailto:jorgenpt@gmail.com">a quick email</a>.</p>
</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person">Posted by <span class="fn" itemprop="name">Jørgen Tjernø</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2021-03-13T17:43:00-08:00"  data-updated="true" itemprop="datePublished dateCreated">13 Mar, 2021</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/rust/'>rust</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://jorgen.tjer.no/post/2021/03/13/registering-a-rust-program-as-a-browser-on-windows/" data-via="" data-counturl="https://jorgen.tjer.no/post/2021/03/13/registering-a-rust-program-as-a-browser-on-windows/" >Tweet</a>
  
  
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/post/2019/01/10/aie-presentation/" title="Previous Post: AIE presentation slides">&laquo; AIE presentation slides</a></li>
            
            
            <li class="next"><a href="/post/2022/02/26/flutter-github-workflows-and-testflight/" title="Next Post: Flutter & GitHub Workflows: Deploying to TestFlight">Flutter & GitHub Workflows: Deploying to TestFlight &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
      <section>
        <h2>Comments</h2>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/post/2023/03/04/unreal-ci/">Unreal Engine and Continuous Integration</a>
    
    <a class="list-group-item " href="/post/2022/02/26/flutter-github-workflows-and-testflight/">Flutter & GitHub Workflows: Deploying to TestFlight</a>
    
    <a class="list-group-item active" href="/post/2021/03/13/registering-a-rust-program-as-a-browser-on-windows/">Registering a (Rust) program as a browser on Windows</a>
    
    <a class="list-group-item " href="/post/2019/01/10/aie-presentation/">AIE presentation slides</a>
    
    <a class="list-group-item " href="/post/2015/10/21/experience-america-presentation/">Experience America presentation slides</a>
    
  </div>
</section>






    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2023 - Jørgen Tjernø<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
  var disqus_shortname = 'jorgenpt';
  
  
  var disqus_config = function () {
    this.page.url = 'https://jorgen.tjer.no/post/2021/03/13/registering-a-rust-program-as-a-browser-on-windows/';
    this.page.identifier = 'https://jorgen.tjer.no/post/2021/03/13/registering-a-rust-program-as-a-browser-on-windows/';
  };
  var disqus_script = 'embed.js';
  
  (function () { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>






  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
