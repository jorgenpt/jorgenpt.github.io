<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>DT_RPATH (ld) & @rpath (dyld) - Jørgen's Blog</title>
  <meta name="author" content="Jørgen Tjernø">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://jorgen.tjer.no/post/2014/05/20/dt-rpath-ld-and-at-rpath-dyld/">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Jørgen's Blog" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://jorgen.tjer.no/post/2014/05/20/dt-rpath-ld-and-at-rpath-dyld/">
  <meta property="og:title" content="DT_RPATH (ld) & @rpath (dyld) - Jørgen's Blog">
  

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">

<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-51279149-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jørgen's Blog</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li>
                    <a href="https://twitter.com/jorgenpt"><i class="fa fa-twitter fa-lg"></i></a>
                </li>
                <li>
                    <a href="https://github.com/jorgenpt"><i class="fa fa-github fa-lg"></i></a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="jorgen.tjer.no">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Jørgen's Blog" />
    
    <meta itemprop="url" content="https://jorgen.tjer.no" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-05-20T22:06:29-07:00"  data-updated="true" itemprop="datePublished dateCreated">20 May, 2014</time>
        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        DT_RPATH (ld) & @rpath (dyld)
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody description"><p>Mac and Linux have two similarly named concepts that both deal with
dynamic loading, that behave quite differently: <code>@rpath</code> (under Mac OS
X&rsquo;s dyld) and <code>DT_RPATH</code> (or just rpath, under Linux' ld.)</p>

<p>Having done development (and more importantly, deployment) on both of
these platforms, I&rsquo;ve experienced first-hand how those concepts can get
a little jumbled in your mind, so here&rsquo;s a brief overview.</p>

<!-- more -->


<a name="DT_RPATH"></a>
<h2>DT_RPATH</h2>

<p>DT_RPATH, or more commonly just rpath, is a property set on an ELF
file<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>. It points to a list of directories that the dynamic linker
will consider when loading a shared library. DT_RPATH is set at
link-time with the <code>-rpath</code> option to <code>ld</code>.  If you invoke <code>ld</code> through
<code>gcc</code> (or another compiler, like <code>g++</code>), then you can use the <code>-Wl</code>
option to pass arguments through to <code>ld</code>. You use commas to separate
arguments passed to <code>-Wl</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ gcc program.c -lm -o program '-Wl,-rpath,$ORIGIN/lib'
</span><span class='line'>$ ldd program | grep libm
</span><span class='line'>        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007f3b9ad94000)
</span><span class='line'>$ mkdir lib && cp /lib/x86_64-linux-gnu/libm.so.6
</span><span class='line'>$ ldd program | grep libm
</span><span class='line'>        libm.so.6 =&gt; /home/jorgenpt/lib/libm.so.6 (0x00007f1440b0c000)</span></code></pre></td></tr></table></div></figure>


<p>The snippet above also shows one of the three special variables<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> you
can include in an rpath, $ORIGIN. $ORIGIN gets replaced at runtime with
the directory in which our executable lives. DT_RPATH is transitive,
meaning it applies to any dependencies of our dependencies (unlike
DT_RUNPATH, but I won&rsquo;t talk about that here.) If our executable links
with libfoo, and libfoo depends on libbar, libfoo will include our rpath
in its search for libbar. (<strong>EDIT 2014-05-25</strong>: You might need
<code>-Wl,-z,origin</code> for GCC to allow $ORIGIN to be expanded.)</p>

<p>$ORIGIN is also commonly expanded by bash or zsh, so we use single
quotes around our <code>-Wl,-rpath,$ORIGIN/lib</code> option to prevent that from
happening. To make sure that $ORIGIN didn&rsquo;t get expanded, you can run
<code>readelf -d my_executable | grep -i rpath</code> to see the value of your
rpath, making sure it starts with <code>$ORIGIN</code>.</p>

<p>To specify multiple paths, separate them by a colon, like
<code>-Wl,-rpath,$ORIGIN/lib:$ORIGIN/lib/amd64</code>.</p>

<p>As you might be able to tell, rpath is great for creating self-contained
applications. You still have to be careful, as any libraries that are
missing from your rpath will still be (silently) searched for in the
system directories. I highly recommend asking users for <code>ldd</code> output if
you&rsquo;re trying to debug something with your dependencies.</p>

<p>Many people use LD_LIBRARY_PATH to achieve a similar effect.
LD_LIBRARY_PATH is not set at link-time, but rather as an environment
variable when your application is run. This is for example what <a href="https://github.com/ValveSoftware/steam-runtime">Valve&rsquo;s
steam-runtime</a> does to guarantee that your dynamically
linked libraries will be picked from the Steam runtime libraries rather
than the system libraries.</p>

<p>The benefit of using LD_LIBRARY_PATH is that it can be set for
applications you cannot edit, but the downside is that it also applies
to any applications launched by the application in question. Say that
you have an application that launches <code>dbus-send</code> or <code>aplay</code> &ndash; since
they&rsquo;re system applications, you&rsquo;d want them to pick their dependencies
from the system, not your LD_LIBRARY_PATH.</p>

<p>Interaction between LD_LIBRARY_PATH and your application&rsquo;s rpath is
well-defined: Your rpath is searched first, and anything it can&rsquo;t find
there it&rsquo;ll look for in LD_LIBRARY_PATH. Finally, if searches the
system directories<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>.</p>

<a name="L.rpath"></a>
<h2>@rpath</h2>

<p>While @rpath is named similarly to its Linux cousin, it behaves a bit
differently. When you dynamically link to a library on Mac OS X, the
linker stores the &ldquo;install name&rdquo; of the library inside your executable.
The install name is something that comes from the dylib you&rsquo;re linking
against, and by default it is the absolute path of the linked file. You
can change the install name by modifying the dylib after linking<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup>.</p>

<p>After your application has been linked, you can change what the
application thinks the install name is for one of its dependent
libraries<sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup>.</p>

<p>Your application can set its own rpath at link-time using the same
<code>-Wl,-rpath,@executable_path</code> magic, but note that instead of $ORIGIN,
you use @executable_path or @loader_path. @executable_path behaves
like $ORIGIN, @loader_path is the directory of whatever object is doing the
loading, which could be a dylib that your application has loaded. For
details, <a href="https://wincent.com/wiki/@executable_path,_@load_path_and_@rpath">read this excellent article by Wincent Colaiuta</a> and
<a href="https://www.mikeash.com/pyblog/friday-qa-2009-11-06-linking-and-install-names.html">this blog post by Mike Ash</a>.</p>

<p>This rpath does <em>not</em> do anything by default. To make it take effect,
the install name for the shared library has to start with <code>@rpath/</code> &ndash;
and the dynamic linker will then substitute each of the possible values
for <code>@rpath</code> in order. This means that you&rsquo;ll typically change the
install name of the dylib (if it&rsquo;s a dylib you built yourself) or change
the install name inside the application.</p>

<p>Under Mac OS X, you have the DYLD_LIBRARY_PATH environment variable &ndash;
and this behaves just like it does on Linux. When DYLD_LIBRARY_PATH is
set, it is checked before the install name (and therefore, @rpath) is
consulted.</p>

<a name="Conclusion"></a>
<h2>Conclusion</h2>

<p>Hopefully this helps you understand some nuances of dynamic linking on
Mac OS X versus Linux. In my next blog post, I hope to show how you can
use DT_RPATH on Linux to link with the Steam runtime when distributing
your game outside of Steam.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>This also applies to .so&rsquo;s - when one of your dynamically loaded libraries load another dynamic library, their rpath is searched first (if any), then your main application&rsquo;s rpath is searched.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>The other two variables are <code>$LIB</code> and <code>$PLATFORM</code>, and they deal with finding architecture-specific binaries.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>The truth is a little more complicated, see the ld.so manpage for more info. (http://man7.org/linux/man-pages/man8/ld.so.8.html)<a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
<li id="fn:4">
<p>See the man page for install_name_tool (<code>install_name_tool -id @rpath/my.dylib my.dylib</code>)<a href="#fnref:4" rev="footnote">&#8617;</a></p></li>
<li id="fn:5">
<p>See the man page for install_name_tool (<code>install_name_tool -change old.dylib @rpath/new.dylib my_application</code>)<a href="#fnref:5" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person">Posted by <span class="fn" itemprop="name">Jørgen Tjernø</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-05-20T22:06:29-07:00"  data-updated="true" itemprop="datePublished dateCreated">20 May, 2014</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/mac-os-x/'>mac os x</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://jorgen.tjer.no/post/2014/05/20/dt-rpath-ld-and-at-rpath-dyld/" data-via="" data-counturl="https://jorgen.tjer.no/post/2014/05/20/dt-rpath-ld-and-at-rpath-dyld/" >Tweet</a>
  
  
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/post/2014/05/19/moving-to-a-new-blog/" title="Previous Post: Moved to a new location!">&laquo; Moved to a new location!</a></li>
            
            
            <li class="next"><a href="/post/2014/05/26/self-contained-game-distribution-on-linux/" title="Next Post: Self-contained game distribution on Linux">Self-contained game distribution on Linux &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
      <section>
        <h2>Comments</h2>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/post/2022/02/26/flutter-github-workflows-and-testflight/">Flutter & GitHub Workflows: Deploying to TestFlight</a>
    
    <a class="list-group-item " href="/post/2021/03/13/registering-a-rust-program-as-a-browser-on-windows/">Registering a (Rust) program as a browser on Windows</a>
    
    <a class="list-group-item " href="/post/2019/01/10/aie-presentation/">AIE presentation slides</a>
    
    <a class="list-group-item " href="/post/2015/10/21/experience-america-presentation/">Experience America presentation slides</a>
    
    <a class="list-group-item " href="/post/2014/05/28/steam-runtime-without-steam/">steam-runtime without Steam</a>
    
  </div>
</section>






    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2022 - Jørgen Tjernø<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
  var disqus_shortname = 'jorgenpt';
  
  
  var disqus_config = function () {
    this.page.url = 'https://jorgen.tjer.no/post/2014/05/20/dt-rpath-ld-and-at-rpath-dyld/';
    this.page.identifier = 'https://jorgen.tjer.no/post/2014/05/20/dt-rpath-ld-and-at-rpath-dyld/';
  };
  var disqus_script = 'embed.js';
  
  (function () { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>






  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
