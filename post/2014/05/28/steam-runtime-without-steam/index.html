<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>steam-runtime without Steam - Jørgen's Blog</title>
  <meta name="author" content="Jørgen Tjernø">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://jorgen.tjer.no/post/2014/05/28/steam-runtime-without-steam/">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Jørgen's Blog" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://jorgen.tjer.no/post/2014/05/28/steam-runtime-without-steam/">
  <meta property="og:title" content="steam-runtime without Steam - Jørgen's Blog">
  

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">

<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-51279149-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jørgen's Blog</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li>
                    <a href="https://twitter.com/jorgenpt"><i class="fa fa-twitter fa-lg"></i></a>
                </li>
                <li>
                    <a href="https://github.com/jorgenpt"><i class="fa fa-github fa-lg"></i></a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="jorgen.tjer.no">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Jørgen's Blog" />
    
    <meta itemprop="url" content="https://jorgen.tjer.no" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-05-28T08:28:28-07:00"  data-updated="true" itemprop="datePublished dateCreated">28 May, 2014</time>
        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        steam-runtime without Steam
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody description"><p><strong>Updated 2014-06-03:</strong> Added information about <code>STEAM_RUNTIME</code> variable under <a href="/post/2014/05/28/steam-runtime-without-steam/#Runtime.dependencies.of.the.steam-runtime">the new embedded search path subsection</a>.</p>

<p><strong>Updated 2016-01-03:</strong> Fixed dead links to Valve&rsquo;s steam-runtime patches collection.</p>

<p>If you&rsquo;ve ever had customers report errors like these, then this post
might be for you:</p>

<ul>
<li><code>./foo: /usr/lib/x86_64-linux-gnu/libstdc++.so.6: version
`GLIBCXX_3.4.16` not found (required by ./foo)</code></li>
<li><code>./foo: error while loading shared libraries: libSDL2-2.0.so.0:
 cannot open shared object file: No such file or directory</code></li>
</ul>


<p>In my <a href="/post/2014/05/26/self-contained-game-distribution-on-linux/">previous post about self-contained distributions</a>,
we started looking at how the <a href="https://github.com/ValveSoftware/steam-runtime">steam-runtime project</a>
works. In this post, we&rsquo;ll make the steam-runtime work for us in a
self-contained distribution that you can ship without depending on
Steam.</p>

<p>I will present two possible ways of doing it:</p>

<ol>
<li>Using <a href="/post/2014/05/28/steam-runtime-without-steam/#Solution.1:.The.wrapper.script">a wrapper script</a>.</li>
<li>Using <a href="/post/2014/05/28/steam-runtime-without-steam/#Solution.2:.Embedded.search.path">an &ldquo;embedded search path&rdquo;</a>.</li>
</ol>


<p>If you&rsquo;re wondering why you would prefer the second approach, that
section starts with a rundown of the benefits inherent to it!</p>

<!-- more -->


<a name="Assumptions"></a>
<h2>Assumptions</h2>

<p>The remainder of this article makes a few assumptions, no matter which
of the two approaches you choose.</p>

<p>I assume that you&rsquo;ve extracted the steam-runtime into a directory named
<code>steam-runtime/</code> next to the executable. The easiest way to do this is
to use the two helper scripts I wrote, see the section on <a href="/post/2014/05/28/steam-runtime-without-steam/#Preparing.the.steam-runtime.for.repackaging">repackaging
the steam-runtime</a>. You should include the steam-runtime
directory when distributing <em>outside of</em> Steam, and distribute the exact
same package <strong>except</strong> for the steam-runtime directory when
distributing <em>through</em> Steam.</p>

<p>Excluding the steam-runtime can be done trivially inside your Steam
depot build script. Assuming you&rsquo;re building a depot from <code>build/linux</code>
(relative to your ContentRoot) with the binary living directly in that
directory, your script would contain something like this:</p>

<pre><code>"DepotBuildConfig"
{
    "DepotID" "1001"

    "FileMapping"
    {
        "LocalPath" "build\linux\*"
        "DepotPath" "."
        "recursive" "1"
    }

    "FileExclusion" "build\linux\steam-runtime"
}
</code></pre>

<p>It&rsquo;s worth noting that the FileExclusion is matched against your local
paths, not your depot paths, and it is implicitly recursive (the latter
doesn&rsquo;t seem to be documented <a href="https://partner.steamgames.com/documentation/steampipe">in the SteamPipe docs</a> as
of 2014-05-28.)</p>

<p>I assume you&rsquo;re already building your game with <a href="https://github.com/ValveSoftware/steam-runtime">the steam-runtime
SDK</a>. This is how you make sure your game is depending on
the right version of the libraries.</p>

<p>Finally, for simplicity sake I&rsquo;m also assuming you don&rsquo;t mind ~100MB of
additional data in your package, which is the size of the entire
steam-runtime for one architecture. If this is too much for you, you can
always manually strip out any unneeded libraries from the runtime.</p>

<a name="Preparing.the.steam-runtime.for.repackaging"></a>
<h3>Preparing the steam-runtime for repackaging</h3>

<p>I&rsquo;ve created <a href="https://github.com/jorgenpt/steam-runtime-helpers">two helper scripts</a>, one to make sure
you&rsquo;ve <a href="https://github.com/jorgenpt/steam-runtime-helpers/blob/master/update_runtime.sh">downloaded the latest runtime</a>, and one to <a href="https://github.com/jorgenpt/steam-runtime-helpers/blob/master/extract_runtime.sh">extract
the parts of the runtime you care about</a> (to reduce runtime
size from 400MB to 100MB, by excluding documentation and whatever
architecture you&rsquo;re <strong>not</strong> using.)</p>

<p>You would invoke them like this to download the latest runtime and
extract the 64bit libraries from it into the <code>build/linux/steam-runtime</code>
directory.</p>

<pre><code>./update_runtime.sh
./extract_runtime.sh steam-runtime-release_latest.tar.xz amd64 build/linux/steam-runtime
</code></pre>

<a name="Solution.1:.The.wrapper.script"></a>
<h2>Solution 1: The wrapper script</h2>

<p>The least invasive way to accomplish what we want is to basically do
what Steam does: Set up the runtime environment variables via
<code>LD_LIBRARY_PATH</code>, and launch the main binary.</p>

<p>To make it even easier, I&rsquo;ve put together <a href="https://github.com/jorgenpt/steam-runtime-helpers/blob/master/launch_wrapper.sh">a little wrapper
script</a> that does exactly that. Name the script <code>foo.sh</code>
or <code>foo</code>, and put it in the same directory as your executable, which it
will then assume is named <code>foo.bin</code>.</p>

<p>The script should gracefully handle being launched from Steam, as it&rsquo;ll
detect that the runtime has already been set up.</p>

<a name="Solution.2:.Embedded.search.path"></a>
<h2>Solution 2: Embedded search path</h2>

<p>First off, why would you prefer this approach to using a wrapper script?</p>

<ul>
<li>Shell scripts are fragile &ndash; it&rsquo;s easy to get something wrong, like
incorrectly handling spaces in filenames, or something equally silly.</li>
<li>A shell script gives you another file that you have to be careful to
maintain the executable bit on.</li>
<li>Shell scripts are text files, and your VCS / publishing process might
mangle the line endings, which makes everyone sad (<code>bad interpreter:
/bin/bash^M: no such file or directory</code>)</li>
<li>A customer could accidentally launch the wrong thing (i.e. the
<code>.bin</code>-file rather than the script), which might work on some
machines, fail in subtle ways on other machines, and not work at all
on the rest of them.</li>
<li>Launching the game in a debugger requires more complexity in your
script, like the <code>--gdb</code> logic in
<a href="https://github.com/jorgenpt/steam-runtime-helpers/blob/master/launch_wrapper.sh">launcher_wrapper.sh</a>, to make the game, but not the
debugger, pick up the runtime libraries.</li>
<li>If you launch any system binaries from outside of the runtime without
taking care to unset <code>LD_LIBRARY_PATH</code>, they will implicitly be using
the runtime libraries, which might not cause problems.</li>
</ul>


<p>The alternative to the wrapper script is using <code>DT_RPATH</code>, which I&rsquo;ve
talked about in <a href="/post/2014/05/20/dt-rpath-ld-and-at-rpath-dyld/">a previous blog post</a>. This approach is a
little more invasive to your build process, but overall it should
require less code.</p>

<p>Simply invoke your linker with the <code>-rpath</code> option pointing to various
subdirectories of the steam-runtime directory. For GCC and Clang, you
would add <code>-Wl,-rpath,&lt;path1&gt;:&lt;path2&gt;:...</code> to the linking step to
accomplish this.</p>

<p>These are the paths to the 64bit libraries in the steam-runtime:</p>

<ul>
<li>amd64/lib/x86_64-linux-gnu</li>
<li>amd64/lib</li>
<li>amd64/usr/lib/x86_64-linux-gnu</li>
<li>amd64/usr/lib</li>
</ul>


<p>These are the paths to the 32bit libraries:</p>

<ul>
<li>i386/lib/i386-linux-gnu</li>
<li>i386/lib</li>
<li>i386/usr/lib/i386-linux-gnu</li>
<li>i386/usr/lib</li>
</ul>


<p>Assuming you&rsquo;re using GCC and the steam-runtime lives next to the
executable, you&rsquo;d use these GCC options for a 64bit binary:</p>

<pre><code>-Wl,-z,origin -Wl,-rpath,$ORIGIN/steam-runtime/amd64/lib/x86_64-linux-gnu:$ORIGIN/steam-runtime/amd64/lib:$ORIGIN/steam-runtime/amd64/usr/lib/x86_64-linux-gnu:$ORIGIN/steam-runtime/amd64/usr/lib
</code></pre>

<p>And you would use these option for a 32bit binary:</p>

<pre><code>-Wl,-z,origin -Wl,-rpath,$ORIGIN/steam-runtime/i386/lib/i386-linux-gnu:$ORIGIN/steam-runtime/i386/lib:$ORIGIN/steam-runtime/i386/usr/lib/i386-linux-gnu:$ORIGIN/steam-runtime/i386/usr/lib
</code></pre>

<a name="Runtime.dependencies.of.the.steam-runtime"></a>
<h3>Runtime dependencies of the steam-runtime</h3>

<p>In addition to redirecting the ELF loader to the steam-runtime, there are some runtime dependencies within those dynamic libraries that need to be redirected as well. Luckily, Valve has done this work for us, and <a href="https://github.com/ValveSoftware/steam-runtime/tree/1a9c7173fc2092a7214eacdd0ffcbff3c5afe1e5/patches">patched these libraries to look elsewhere</a>. In order to know what the &ldquo;base&rdquo; of the runtime is, it looks at the <code>STEAM_RUNTIME</code> environment variable.</p>

<p>The first version of this post didn&rsquo;t include this detail, and you might&rsquo;ve run into errors like these:</p>

<pre><code>symbol lookup error: /usr/lib/x86_64-linux-gnu/gio/modules/libdconfsettings.so: undefined symbol: g_mapped_file_get_bytes
</code></pre>

<p>This is because glib has a <a href="https://github.com/ValveSoftware/steam-runtime/blob/1a9c7173fc2092a7214eacdd0ffcbff3c5afe1e5/patches/glib2.0/01_steam_runtime_path.patch#L16">runtime search for plugins</a> that directly calls <code>dlopen()</code> on an absolute path.</p>

<p>The solution to this problem is to have the first thing in your <code>main()</code> method on Linux be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;STEAM_RUNTIME&quot;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">setenv</span><span class="p">(</span><span class="s">&quot;STEAM_RUNTIME&quot;</span><span class="p">,</span> <span class="n">figureOutSteamRuntimePath</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A full sample for your <code>main()</code> is <a href="https://github.com/jorgenpt/steam-runtime-helpers/blob/master/sample_embedded_path_main.c">available in the helpers GitHub repository</a>.</p>

<a name="Conclusion"></a>
<h2>Conclusion</h2>

<p>With just a small modification to your build system and a ~100MB larger
distribution, you can make your executables run across a wide variety of
Linux distributions and user setups. I highly recommend the embedded
search path solution, which is what I used for <a href="http://www.uberent.com/pa/">Planetary
Annihilation</a>&rsquo;s Linux release.</p>

<p>When shipping your own steam-runtime, you are responsible for updating
the runtime. The date of the latest update can be found inside the
<a href="http://media.steampowered.com/client/runtime/steam-runtime-release_latest.tar.xz.md5">runtime MD5 file</a>. In addition, you are responsible for
respecting the licenses of all the packages included in the runtime &ndash;
including any clauses regarding redistribution.</p>
</div>


      <footer>
        <p class="meta text-muted">
          
  

<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person">Posted by <span class="fn" itemprop="name">Jørgen Tjernø</span></span>

          












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-05-28T08:28:28-07:00"  data-updated="true" itemprop="datePublished dateCreated">28 May, 2014</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/game-development/'>game development</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/steam-runtime/'>steam runtime</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://jorgen.tjer.no/post/2014/05/28/steam-runtime-without-steam/" data-via="" data-counturl="https://jorgen.tjer.no/post/2014/05/28/steam-runtime-without-steam/" >Tweet</a>
  
  
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/post/2014/05/26/self-contained-game-distribution-on-linux/" title="Previous Post: Self-contained game distribution on Linux">&laquo; Self-contained game distribution on Linux</a></li>
            
            
            <li class="next"><a href="/post/2015/10/21/experience-america-presentation/" title="Next Post: Experience America presentation slides">Experience America presentation slides &raquo;</a></li>
            
          </ul>
        
      </footer>
    </article>
    
      <section>
        <h2>Comments</h2>
        <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
      </section>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/post/2015/10/21/experience-america-presentation/">Experience America presentation slides</a>
    
    <a class="list-group-item active" href="/post/2014/05/28/steam-runtime-without-steam/">steam-runtime without Steam</a>
    
    <a class="list-group-item " href="/post/2014/05/26/self-contained-game-distribution-on-linux/">Self-contained game distribution on Linux</a>
    
    <a class="list-group-item " href="/post/2014/05/20/dt-rpath-ld-and-at-rpath-dyld/">DT_RPATH (ld) & @rpath (dyld)</a>
    
    <a class="list-group-item " href="/post/2014/05/19/moving-to-a-new-blog/">Moved to a new location!</a>
    
  </div>
</section>






    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2018 - Jørgen Tjernø<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'jorgenpt';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://jorgen.tjer.no/post/2014/05/28/steam-runtime-without-steam/';
        var disqus_url = 'https://jorgen.tjer.no/post/2014/05/28/steam-runtime-without-steam/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
